---
layout: post
title: DevOps
subtitle: DevOps
tags: [DevOps,敏捷开发,CI,CD]
---


## DevOps是什么

> DevOps是软件开发、运维和质量保证三个部门之间的沟通、协作和集成所采用的流程、方法和体系的一个集合。它是人们为了及时生产软件产品或服务，以满足某个业务目标，对开发与运维之间相互依存关系的一种新的理解。


![](http://oqk2bkk90.bkt.clouddn.com/14982072771613.jpg)

### DevOps概念

DevOps是一种融合了一系列基本原则和实践的方法论（并从这些实践中派生出了各种工具），意在帮助这些人员向着一个统一的共同目的努力：**尽可能为公司提供更多价值**。令人惊奇的是，这个问题还有一个非常简单的“银弹”：**让生产端变得敏捷起来！** 而这恰恰正是DevOps所要达成的**唯一目标**



> 在进一步讨论这一点之前，首先需要谈谈其他几件事

-------

- 管理信条
- 一个典型的IT组织
- 时间都去哪了
- 基础架构自动化
- 银弹



### 管理信条

IT管理这场战争的原动力到底是什么？换句话说，在软件开发项目中，管理工作首要的，以及最重要的目的是什么？

**当然是要加快上市时间（TTM）** 

上市时间（即TTM）是指一件产品从最初的构思到最终可供用户使用或购买这一过程所需要的时间。TTM通常也会被叫做前置时间（Lead Time）。

第一个问题在于，（很多人认为）在开发过程中TTM和产品质量是两个对立的属性。改善质量（进而提高稳定性）是负责运行软件的运维人员的目的，而负责构建软件的开发者的目的在于降低前置时间（进而提高TTM. 



### 一个典型的IT组织
![一个典型的IT组织图](http://oqk2bkk90.bkt.clouddn.com/14982071219886.jpg)



### 时间都去哪了

![](http://oqk2bkk90.bkt.clouddn.com/14984417781058.jpg)

生产团队有将近一半（47%）的时间花在了与部署有关的工作中：

* 执行实际的部署工作，或
* 修复与部署工作有关的问题



### 基础架构自动化

![](http://oqk2bkk90.bkt.clouddn.com/14982077583178.jpg)
这些统计告诉我们：

只需手工运行5条命令的情况下，成功部署的概率就已跌至86%。
如需手工运行55条命令，成功部署的概率将跌至22%。
如需手工运行100条命令，成功部署的概率将趋近于0（仅2%）！



### DevOps：仅此一次，一颗神奇的银弹
![](http://oqk2bkk90.bkt.clouddn.com/14982079261283.jpg)



- DevOps主要通过扩展敏捷开发实践，通过构建，验证，部署和交付,来进一步简化软件更改的移动，同时赋予跨职能团队完全拥有软件应用程序 - 从设计到生产支持
- DevOps鼓励软件开发者和IT运维人员之间所进行的沟通、协作、集成和自动化，借此有助于改善双方在交付软件过程中的速度和质量。
- DevOps团队更侧重于通过标准化开发环境和自动化交付流程改善交付工作的可预测性、效率、安全性，以及可维护性。理想情况下，DevOps可以为开发者提供更可控的生产环境，帮助他们更好地理解生产基础架构。
- DevOps鼓励团队自主进行自己应用程序的构建、验证、交付和支持。



## DevOps能给我们带来什么



### **可重复性与可靠性**
时至今日，构建生产用计算机只需要运行脚本或必要的puppet命令即可。通过恰当地使用Docker容器或Vagrant虚拟机，只需运行一条命令即可配置好包含操作系统层以及所需软件和配置的生产用计算机。当然，随着各种变更或软件开发、持续集成，并自动测试，这套构建脚本或机制也会进行持续集成。
最终幸亏有了XP或敏捷，我们在软件开发端所使用的同一套实践也能让运维端获益。


### **生产力**
一键部署，一键供应，一键创建新环境……整个生产环境可以通过一条命令或一键点击的方式创建。这样的一条命令也许会运行长达数小时，但在这过程中运维人员可以从事其他更有趣的工作，而无需等待一条命令执行完毕后继续输入下一条命令，毕竟这样的过程有时候可能需要花费几天时间才能完成……


### **恢复时间**
一键点击即可恢复生产环境，就是这么简单。


### **确保基础架构的同质**
彻底避免运维人员每次构建环境或安装软件时最终获得的结果与预期有所差异，这是确保基础架构绝对同质,并且可再现的唯一可行方法。以此为基础，通过对脚本或Puppet配置文件使用版本控制机制，我们甚至可以重建出与上周、上个月，或软件特定版本发布时完全一致的生产环境。


### **维持整齐划一的标准**
基础架构标准甚至可以不复存在，代码本身就是标准。


### **让开发者自行完成大部分工作**
如果开发者自己突然可以在自己的基础架构上一键点击重建生产环境，他们也就可以自行完成很多与生产环境有关的任务，例如更好地理解生产失败，提供更恰当的配置，实现部署脚本等。

亚马逊CTOWerner Vogel甚至在2014年说过：

“谁开发，谁运行。”

### **发现浪费**
1. 一些不必要的多分支开发，合并后发生问题的风险高。多个项目中可能都要修改同一个模块的代码，每次在最后合并代码时都会出现一些问题，非常痛苦，尤其是修改比较大的时候，合并及修复时间较长。
2. 推迟问题被发现的时间。每个开发人员会将需求分解成多个技术任务后开发。所以，所有任务完成之前，应用程序一直处于不可用状态。当最后在一起联调时，常常会发现一些意想不到的问题。
3. 基于流程平台的沟通。在提测环节中，沟通完全基于内部项目管理平台和即时消息工具或Email。
4. 常规的例行工作很难自动化。

从上面这些内容，不难发现，流程中更倾向于将问题推迟到后面解决（比如最后集成联调），将工具（平台、邮件、即时通讯）作为协作的基础，而角色间的沟通几乎完全依赖于前一个环节的产物（比如MRD、产品代码、上线步骤）。我们可以使用哪些对策进行优化，达到消除浪费的目的呢？




## DevOps如何落地

> 纸上听来终觉浅,实践是检验真理的唯一标准.



-------
![](http://oqk2bkk90.bkt.clouddn.com/14982080278052.jpg)



### IaC(基础架构即代码)

基础架构即代码（IaC）是大部分通用DevOps实践的前提要求，例如版本控制、代码审阅、持续集成、自动化测试。这一概念涉及计算基础架构（容器、虚拟机、物理机、软件安装等）的管理和供应，以及通过机器可处理的定义文件或脚本对其进行的配置，交互式配置工具和手工命令的使用已经不合时宜了。

这一原则对DevOps的重要性怎么强调都不为过，它可以真正将软件开发相关的实践应用给服务器和基础架构。



### 持续交付
持续交付是一种可以帮助团队以更短的周期交付软件的方法，该方法确保了团队可以在任何时间发布出可靠的软件。该方法意在以更快速度更高频率进行软件的构建、测试和发布。

注意：持续交付 ≠ 持续部署



持续交付的主要想法在于：

部署越频繁，对部署流程就会越熟悉，自动化机制就能获得更好的结果。
部署越频繁，所部属的变更集就越微不足道，而这些内容最有可能出错。
部署越频繁，TTR（修复／解决所需时间）指标就会越出色，从业务用户处获得有关功能的各类反馈的速度越快


但持续交付并不仅仅是尽可能频繁地构建可发布、生产就绪版本的软件产品那么简单。持续交付包含3个关键实践：

-------

* 从实践中学习
* 自动化
* 更频繁的部署



1. 从实践中学习
    
    痴迷于度量,我们应该度量一切！
    
    不需要“考虑”，只需要“知道”！“知道”的唯一方法就是度量，度量一切：响应时间、用户思考时间、展示次数、API调用次数、点击率等，但这些并非需要度量的全部。找出所有能让你更进一步了解用户对功能看法的度量指标，对所有这些指标进行度量！



2. 自动化
    > 这里想强调的是，在没有将与基础架构有关的所有供应和任务实现妥善、全面的自动化之前，持续交付根本无从谈起。
    


3. 更频繁的部署

    DevOps的信条在于：“越是困难的事，需要更频繁地进行！”
    自动化测试、重构、数据库迁移、面向客户的产品规格、规划、发布 - 所有这些活动都要尽可能频繁地进行。

那么这就产生了一个问题：使用DevOps方法时，该选择怎样的交付频率？

最佳理论值应该是：如果不能实现**至少每两周一次交付**，或在冲刺阶段结束时交付，那么连敏捷都谈不上，DevOps又从何谈起呢？



### 持续交付的前提需求
在改为使用持续交付方式之前，需要满足如下需求：

* 对软件组件的开发和平台的供应和设置进行持续集成。
* TDD - 测试驱动的开发。
* 代码审阅！至少要进行代码审阅……如果能进行结对编程（Pair programming）当然就更好了。
* 软件的持续审计 - 例如使用Sonar。
* 在生产级环境实现功能测试的自动化。
* 更强大的非功能测试自动化（性能、可用性等）。
* 独立于目标环境的自动化打包和部署。
* 另外在管理重大功能和演进时，还需要具备健全的软件开发实践，例如零停机部署技术。



### 零停机部署

“零停机部署（ZDD）可在不中断现有服务的情况下部署新版系统。”

下文简单介绍4种技术：

* **功能开关（Feature Flipping）**
* **滚动部署（Dark launch）**
* **蓝／绿部署（Blue/Green Deployment）**
* **金丝雀发布（Canari release）**



### 团队协作
敏捷软件开发破除了需求分析、测试和开发之间的一些隔阂。部署、运维和维护等其他活动与软件开发过程中的其他环节也存在类似的分隔。DevOps方法意在破除所有这些隔阂，鼓励开发和运维人员之间的协作。

如果没有培养出正确的文化，就算有最棒的工具，DevOps对你而言也不过是另一个热门词汇罢了。

DevOps文化的主要特征在于开发和运维角色之间日益增加的协作。这是一种在团队内部以及组织层面上很重要的文化变迁，通过这样的变迁才能促进更好的协作。


![](http://oqk2bkk90.bkt.clouddn.com/14982096057176.jpg)



团队合作对DevOps是如此的重要，大部分方法论所要实现的最终目标总的来说可以通过两个C来实现：**协作（Collaboration）**和**沟通（Communication）**。虽然单纯做到这些距离真正的DevOps工作环境还有很大的差距，但任何公司只要能坚持这两个C，就等于迈出了最正确的第一步。



### DevOps落地障碍



#### 混乱之墙

![](http://oqk2bkk90.bkt.clouddn.com/14982097271016.jpg)

在传统开发周期中，开发团队将新发布的软件“隔墙扔给”运维人员，意味着自己的工作已经顺利完成。

运维人员接手开发者的成果，准备开始进行部署。运维人员手工修改由开发者提供的部署脚本，当然更多时候这些脚本都是运维人员自己维护的。

运维人员还需要手工修改配置文件，以反映生产环境的需求，而生产环境往往与开发或QA环境有很大差异。

就算最理想的情况，运维人员可能只是做了一些在上一个环境中已经做过的重复工作，而最糟糕的情况，可能会引入或发现新的Bug。


随后IT运维团队开始讨论他们所认为的，目前最正确的部署流程，然而由于开发和运维在脚本、配置、流程，甚至环境等方面的差异，基本上等同于要从零开始将所有工作重新执行一遍。

当然这一过程中不可避免会遇到问题，他们联系开发者希望进行排错。运维称开发者提供的代码本身有问题，开发者则回应称代码在自己的环境中一切正常，因此错误肯定源自运维端。

由于配置、文件位置，以及面临这种状态所执行的操作与自己的预期等因素存在较大差异，开发者甚至很难对这样的问题进行诊断。变更窗口留下的时间所剩无几，当然也没什么足够靠谱的方法将环境回滚至上一个正常状态。

那么原本应该一帆风顺的部署过程，为什么最后却变成了“众志成城”的应急演习？必须经历大量指责和错误才能最终让生产环境恢复可用状态？

这种情况经常发生，经常！



#### 软件开发流程
下图简要描述了敏捷软件开发流程通常的样子。
![](http://oqk2bkk90.bkt.clouddn.com/14982100328183.jpg)

最开始，业务代表与产品负责人以及架构团队合作定义软件，这一过程可能会使用Story Mapping和用户故事，或者使用更完整的规范。

随后开发团队通过短暂的开发冲刺开发出软件，并在每个冲刺结束后将生产就绪版本的软件发布给业务用户，进而收集反馈并尽可能频繁地调整方向。

最后，经历过每个新的里程碑后，将软件部署给整个业务线更广泛的用户群体。

![](http://oqk2bkk90.bkt.clouddn.com/14982100440048.jpg)


DevOps造成的最大挑战在于需要理解运维人员是软件的另一个用户群体！因此他们也应该被全面纳入软件开发流程中。

在预定的时间里，运维应该给出自己的非功能需求，就如同业务用户给出自己的功能需求一样。开发团队应该按照同等程度的重要性和优先级处理这种非功能需求。

在实现的过程中，运维应该持续提供反馈和非功能测试规范，就像业务用户针对功能特性提供反馈一样。

最后，运维和业务用户一样，成为了软件的用户。



#### 共享工具
在传统的大型企业中，运维团队和开发团队分别使用专用的，没有什么交集的工具集。

运维人员通常并不想了解开发团队所使用的SCM系统以及持续集成环境。他们认为这些并非自己的本职工作，害怕自己在触及这些系统后会被开发者的各种请求所淹没。毕竟他们为了照料生产系统就有忙不完的工作了。

另一方面，开发者通常无法访问生产系统的日志和监视日志，有时这是因为没有这样的意愿，有时则是因为制度或安全方面的顾虑。

这种状况需要改变！DevOps应运而生。

![](http://oqk2bkk90.bkt.clouddn.com/14982101389443.jpg)



#### 协同工作
DevOps的一种基本哲学是认为，开发者和运维人员必须定期进行密切的合作。

这就意味着他们必须将对方视作重要的利益相关者，并积极主动地寻求合作。

受到XP实践中“现场客户”的启发，敏捷开发者受此激励可以与业务进行更紧密的合作，自律的敏捷者还可以更进一步将这样的实践运用给更广泛的利益相关者，例如可以让开发者与所有其他相关者进行合作，包括运维和支持人员。


![](http://oqk2bkk90.bkt.clouddn.com/14982102319749.jpg)

此外还可以通过协作：

让运维人员参与敏捷仪式（每日Scrum、冲刺规划、再次冲刺等）
让开发者参与生产环境的推出任务
在开发和运维之间打造统一的持续改进目标



## DevOps工具链



### DevOps工具概述

> DevOps实际是一种文化上的变迁，代表了开发、运维、测试等环节之间的协作，因此DevOps工具是非常多种多样的，甚至可以由多种工具组成一个完整的DevOps工具链。此类工具可以应用于一种或多种类别，并可体现出软件开发和交付过程的不同阶段：


1. 编码：代码开发和审阅，版本控制工具、代码合并工具
2. 构建：持续集成工具、构建状态统计工具
3. 测试：通过测试和结果确定绩效的工具
4. 打包：成品仓库、应用程序部署前暂存
5. 发布：变更管理、发布审批、发布自动化
6. 配置：基础架构配置和部署，基础架构即代码工具
7. 监视：应用程序性能监视、最终用户体验


虽然可用工具有很多，但其中一些环节是组织内部应用DevOps工具链不可或缺的。
诸如Docker（容器化）、Jenkins（持续集成）、Puppet（基础架构构建）、Vagrant（虚拟化平台）等常用、广泛使用的工具都是2016年的DevOps热门工具。

基础架构组件的版本控制、持续集成和自动化测试

基础架构的版本控制能力（而非基础架构的构建脚本或配置文件）及对其进行自动化测试的能力极其重要。
此外基础架构元素应该能向软件交付物一样进行持续集成



### DevOps工具清单

![企业的软件交付价值流动](http://oqk2bkk90.bkt.clouddn.com/14869758651397.jpg)

* 代码管理（SCM）：GitHub、GitLab、BitBucket、SubVersion、TFS
* 构建工具：Ant、Gradle、maven
* 自动部署：Capistrano、CodeDeploy
* 持续集成（CI）：Bamboo、Hudson、Jenkins
* 配置管理：Ansible、Chef、Puppet、SaltStack、ScriptRock GuardRail
* 容器：Docker、LXC、Rkt、第三方厂商如AWS
* 编排：Kubernetes、Apache Mesos、DC/OS、Rancher
* 服务注册与发现：Zookeeper、etcd、Consul
* 脚本语言：python、ruby、shell
* 日志管理：ELK、Logentries
* 系统监控：Datadog、Graphite、Icinga、Nagios
* 性能监控：AppDynamics、New Relic、Splunk
* 压力测试：JMeter、Blaze Meter、loader.io
* 预警：PagerDuty、pingdom、厂商自带如AWS SNS
* HTTP加速器：Varnish
* 消息总线：ActiveMQ、SQS
* 应用服务器：Tomcat、JBoss
* Web服务器：Apache、Nginx、IIS
* 数据库：MySQL、Oracle、PostgreSQL等关系型数据库；cassandra、mongoDB、redis等NoSQL数据库
* 项目管理（PM）：Jira、Asana、Taiga、Trello、Basecamp、Pivotal Tracker




 ![持续交付流水线下的团队协作](http://oqk2bkk90.bkt.clouddn.com/14869759221117.jpg)



## 总结
* DevOps是一次革命，主要是为了消除拥有大规模IT部门的大型企业中，开发团队和运维团队之间由于历史原因产生的隔阂与孤立所造成的混乱现状。

* 在笔者15年的职业生涯中，2/3的时间就职于此类大行机构，其中大部分是金融机构，每天笔者都在见证者这堵混乱之墙的存在。例如笔者经常会听到这样的说法：

> 在笔者的Tomcat上工作很正常，很抱歉，但笔者完全不懂你所用的Websphere，帮不上你了。”（开发者说）
“我们真的不能从生产数据库中给你提取这张表，里面包含了与客户有关的机密数据。”（运维人员说）
每天都会遇到其他很多类似的对话……天天如此！

那么对于那些小规模的，开发和运维职能之间通常不会产生那么大分歧的企业呢？
这样的企业应用DevOps原则和实践，例如自动化部署、持续交付和功能开关，一样能获益匪浅。



DevOps原则可以总结为：

![](http://oqk2bkk90.bkt.clouddn.com/14982105396780.jpg)



## 参考资料
- [http://www.infoq.com/cn/articles/detail-analysis-of-devops#](http://www.infoq.com/cn/articles/detail-analysis-of-devops#)
- [https://blog.profitbricks.com/51-best-devops-tools-for-devops-engineers/](https://blog.profitbricks.com/51-best-devops-tools-for-devops-engineers/)
- [https://www.niceideas.ch/roller2/badtrash/entry/devops-explained](https://www.niceideas.ch/roller2/badtrash/entry/devops-explained)



## Thanks!


